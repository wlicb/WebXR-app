<html>
  <head>
    <title>A-Frame Marker-less Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1f00d0beadf87bad7d275c174616e048f8b573fc/dist/aframe-master.min.js"></script>
    <script src="/app.js"></script>
    <script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-click-drag-component"></script>
    <script src="/hammer.min.js"></script>
    <script>
      registerAframeClickDragComponent(window.AFRAME);
    </script>
    <style> .a-enter-vr-button { display: none; } </style>
  </head>
  <body>
    <a-scene background="color: black" webxr="optionalFeatures: hit-test, local-floor, viewer; referenceSpaceType: local" cursor="rayOrigin: mouse">

      <a-entity id="world" position="0 0 -3" hide-in-ar-mode>

        <!--<a-box id="box" position="0 0.25 0" scale="0.5 0.5 0.5" material="color: blue; opacity: 0.9" shadow></a-box>-->       
      
      </a-entity>
      
      <!-- This is the pointer for working out where to place the object -->
      <a-entity id="reticle" visible="false" ar-hit-test="offset: 0 0">
        <a-ring rotation="-90 0 0" scale="0.15 0.15 0.15" color="white" material="shader: flat" opacity="0.9"></a-ring>
      </a-entity>
      <a-entity camera look-controls>
        <a-entity id="cursor"
                  cursor="fuse: true"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                  material="color: black; shader: flat"
                  raycaster="objects: .clickable"
                  hide-in-ar-mode>
          <!--cursor="fuse: true; fuseTimeout: 500"-->
        </a-entity>
      </a-entity>
    </a-scene>
    <script>
      /*function overlap(el1, position) {
        // helper function for the function valid: check whether a location is in an object.
        var pos1 = el.getAttribute('position');
        var depth = el.getAttribute('depth') / 2;
        var width = el.getAttribute('width') / 2 ;
        var height = el.getAttribute('height') / 2;
        if (
          (pos.x > pos1.x - depth) && (pos.x < pos1.x + depth) || 
          (pos.y > pos1.y - width) && (pos.y < pos1.y + width) ||
          (pos.z > pos1.z - height) && (pos.z < pos1.z + height)
        )
          return true;
        return false;
      }
      
      function valid(pos) {
        // TODO: check whether the location of the new object is valid, i.e., overlaps with and other object. (no need)
        var els = document.querySelectorAll('a-box')
        for (var i = 0; i < els.elgnth; i++) {
          if (overlap(els[i], pos))
            return false;
        }
        return true;
      }*/
      
      
      // Handle input
      const reticle = document.getElementById('reticle');
      reticle.addEventListener('select', function (event) {
        
        if (
          event.detail.inputSource.profiles[0] === "generic-touchscreen" &&
          event.detail.inputSource.gamepad
        ) {
          // Handle input if you want via the axes -1, -1 is top left, 1, 1 is bottom right
          const x = event.detail.inputSource.gamepad.axes[0];
          const y = event.detail.inputSource.gamepad.axes[1];
          console.log(x,y);
        }
        
        // Get the next hit event to position the element
        reticle.addEventListener('hit', function () {
          if (document.querySelector('a-scene').is("ar-mode")) {
            const position = this.getAttribute('position');
            //document.getElementById('world').setAttribute('position', position);
            // Instantiate only one box and fix its location first (test feature)
            var scene = document.querySelector('a-scene');
            if (scene.querySelectorAll('a-box').length == 0)
              {
              // Instantiate a box at the correct place
                
                var boxEl = document.createElement('a-box');
              // Do `.setAttribute()`s to initialize the entity.
                boxEl.setAttribute('position', position);
                boxEl.setAttribute('scale', '0.5 0.5 0.5');
                boxEl.setAttribute('material', 'color', 'blue');
                boxEl.setAttribute('opacity', 0.9);
                boxEl.setAttribute('shadow');
                boxEl.setAttribute('choose', 'color', 'red');
                //boxEl.setAttribute('event-set__mouseenter', 'color', 'red');
                boxEl.setAttribute('move');
                boxEl.classList.toggle('clickable');
                //boxEl.setAttribute('click-drag');
                //boxEl.setAttribute('resize');
                scene.appendChild(boxEl);
                document.querySelector('a-ring').setAttribute('visible', false);
              }
          }
        }, {
          once: true
        });
      });
    </script>
    <script>
      /*AFRAME.registerComponent('selected', {
        schema: {
          selected: {default: false}
        }
      });*/
      
      AFRAME.registerComponent('choose', {
        // select the object when the cursor enters the object
        schema: {
          color: {default: 'red'},
          selected: {default: 'false'},
          oldColor: {default: 'blue'}
        },
        
        init: function sel(){
          var data = this.data;
          this.el.addEventListener('click', function () {
            //var status = the status of the box
            //var status = false;
            //if (status == false)
            if (data.selected == 'false')
              {
                document.querySelector('a-box').setAttribute('material', 'color', data.color);
                //this.setAttribute('selected', 'true');
                data.selected = 'true';
                status = true;
              }
            //else if (data.selected == 'true')
            else
              {
                document.querySelector('a-box').setAttribute('material', 'color', 'blue');
                //this.setAttribute('selected', 'false');
                data.selected = 'false';
                status = false;
              }
                //this.setAttribute('color', data.color);
                //this.setAttribute('selected', true);
          });
          /*this.el.addEventListener('mouseleave', function() {
            this.setAttribute('color', old_color);
            this.setAttribute('selected', 'false');
          });*/
        }
      });
    </script>
    <script>
      AFRAME.registerComponent('move',{
        // TODO: move the object when it is selected
        init: function(){
          if (this.el.getAttribute('choose').selected == 'true')
          {
            /*this.el.addEventListener('mousedown', function() {
              const position = document.getElementById('reticle').getAttribute('position');
              this.el.setAttribute('color', 'green');
            });*/
            hammertime.on('pan', (ev) => {
              this.el.classList.remove('clickable');
              this.el.setAttribute("position", ev.position);
              this.el.classList.toggle('clickable');
            });
          }
        }
        /*},
        update: function () {
          const position = document.getElementById('reticle').getAttribute('position');
          this.el.setAttribute('position', position);
        }*/
      });
      
    </script>
    <script>
      AFRAME.registerComponent('resize', {
        // TODO: resize the object when do scaling on the screen when it is selected
        init: function(){
          if (this.el.getAttribute('choose').selected == 'true')
          {
             /*this.el.addEventListener('click', function() {
               //const scale = {1, 1, 1};
               //this.el.setAttribute('scale', scale);
               var anim = document.createElement('a-animation');
               anim.setAttribute('attribute', 'scale');
               anim.setAttribute('from', '0.5 0.5 0.5');
               anim.setAttribute('to', '1 1 1');
               document.querySelector('a-box').appendChild(anim);
             });*/
            /*var element = document.querySelector('a-box');
            var hammertime = new Hammer(element);
            hammertime.on("pinch", (ev) => {
                let scale = {x:ev.scale, y:ev.scale, z:ev.scale}
                element.setAttribute("scale", scale);
            });*/
          }
        }
      });
    </script>

  </body>
</html>